<!-- Define the container placement tag container -->
<div id="okanjo-placement-container">
    <div class="okanjo-placement" data-key="PUT_YOUR_WIDGET_KEY_HERE"></div>
</div>

<!--
This script will asynchronously load the Ad or Product widget as configured. It will automatically move the drop-zone
outside of the iframe (when able to do so) to enable expandable functionality.
-->
<script>
    /*! Okanjo Placement Loader v3.0.1 - https://developer.okanjo.com/okanjo-js */
    (function (config) {

        //noinspection ES6ConvertVarToLetConst
        var doc = document,
            win = window,
            container = doc.getElementById('okanjo-placement-container'),
            isTop = win.top === win.self,
            isFrameLocated = false;

        try {
            // If we're sandboxed to an iframe, try to move the dropzone element to the top-level DOM
            if (!isTop) {

                // Locate all the iFrames on the main page
                //noinspection ES6ConvertVarToLetConst
                var iframes = win.top.document.getElementsByTagName('iframe'),
                    i = 0, frame, frameDocument;

                // Check each, to see if the frame's document matches the current document
                for (; i < iframes.length; i++) {
                    frame = iframes[i];
                    try {
                        frameDocument = frame.contentDocument || iframes.contentWindow.document; // <-- this can throw
                        if (frameDocument === document) {
                            // We found our frame! - that means we're friendly and can promote our content
                            // Strip our internal ID off before attaching to the main page
                            container.removeAttribute('id');
                            // Move our container element to the main page, adjacent to our iframe
                            frame.parentNode.appendChild(container);
                            // Hide the iframe, since there will be nothing in it anymore
                            frame.style.display = "none";
                            // Set the page context in which to initialize our widget
                            doc = win.top.document;
                            win = win.top;
                            // Flag that everything is perfect
                            isFrameLocated = true;
                            break;
                        }
                    } catch (e) {
                        // Trying to pull the contentDocument of an unfriendly iframe will throw - so eat the error
                    }
                }
            }
        } catch (e) {
            // CORS issue or iframe is not friendly, so we're stuck within this iframe. Report the exception.
            console.warn('[Okanjo]', 'Failed to locating parent frame.', e);
        }

        // Override if we could not escape and we should have
        if (!isTop && !isFrameLocated) {
            // Report
            console.warn('[Okanjo]', 'Forcing non-expandable functionality.');
            // Force non-expandable since we failed to escape
            config.placement && (config.placement.expandable = false);
        }

        //
        // Load the widget payload -------------------------------------------------------------------------------------
        //
        // Async load Okanjo-JS
        (function (callback) {
            if (this.okanjo) {
                // Already loaded
                callback.call(this);
            } else {
                // The context here should be the window of the target frame
                //noinspection ES6ConvertVarToLetConst
                var win = this,
                    document = win.document,
                    body = document.getElementsByTagName('body')[0],
                    script = document.createElement('script'),
                    scriptLoaded = false;
                script.type = 'text/javascript';
                script.async = true;
                script.setAttribute('crossorigin', "anonymous");
                // When the script loads, fire our callback
                script.onload = script.onreadystatechange = function () {
                    if (!scriptLoaded &&
                        (!this.readyState || this.readyState === 'complete' || this.readyState === 'loaded')) {
                        scriptLoaded = true;
                        // Framework loaded, move on to widget initialization
                        callback.call(win);
                    }
                };
                // Start loading the widget payload
                script.src = config.src || "//cdn.okanjo.com/js/latest/okanjo-bundle.min.js";
                body.parentNode.insertBefore(script, body);
            }
        }).call(win, function () {

            //noinspection ES6ConvertVarToLetConst
            var win = this, targets = win.okanjo.qwery('.okanjo-placement:not(.loaded)', container), i = 0;

            // Create a bucket for the widget instance, if not already present (e.g. multiple ads on a page)
            win.__okanjoPlacements = win.__okanjoPlacements || [];

            for (; i < targets.length; i++) {
                targets[i].className += ' loaded';
                win.__okanjoPlacements.push(new win.okanjo.Placement(targets[i], config.placement));
            }
        });

    })({
        placement: {
            // key: 'PUT_YOUR_PLACEMENT_KEY_HERE',
            // expandable: true,
            proxy_url: '%%CLICK_URL_UNESC%%', // (Google DFP macro, change for your ad server)
        }
    });
</script>