/*! okanjo-metrics.js v1.20.0 | (c) 2013 Okanjo Partners Inc | https://okanjo.com/ */
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.okanjo=t()}(this,function(){function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var t=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Array.from||(Array.from=function(){var e=Object.prototype.toString,t=function(t){return"function"==typeof t||"[object Function]"===e.call(t)},n=function(e){var t=Number(e);return isNaN(t)?0:0!==t&&isFinite(t)?(t>0?1:-1)*Math.floor(Math.abs(t)):t},r=Math.pow(2,53)-1,o=function(e){var t=n(e);return Math.min(Math.max(t,0),r)};return function(e){var n=this,r=Object(e);if(null==e)throw new TypeError("Array.from requires an array-like object - not null or undefined");var i,a=arguments.length>1?arguments[1]:void 0;if("undefined"!=typeof a){if(!t(a))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(i=arguments[2])}for(var u,s=o(r.length),c=t(n)?Object(new n(s)):new Array(s),l=0;l<s;)u=r[l],a?c[l]="undefined"==typeof i?a(u,l):a.call(i,u,l):c[l]=u,l+=1;return c.length=s,c}}()),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var r=arguments[1],o=0;o<n;){var i=t[o];if(e.call(r,i,o,t))return i;o++}}}),Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var r=arguments[1],o=0;o<n;){var i=t[o];if(e.call(r,i,o,t))return o;o++}return-1}}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){function n(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t)}if(null==this)throw new TypeError('"this" is null or not defined');var r=Object(this),o=r.length>>>0;if(0===o)return!1;for(var i=0|t,a=Math.max(i>=0?i:o-Math.abs(i),0);a<o;){if(n(r[a],e))return!0;a++}return!1}}),window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=function(e,t){t=t||window;for(var n=0;n<this.length;n++)e.call(t,this[n],n,this)}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),r=1;r<arguments.length;r++){var o=arguments[r];if(null!=o)for(var i in o)Object.prototype.hasOwnProperty.call(o,i)&&(n[i]=o[i])}return n},writable:!0,configurable:!0});var r=function(e,t){var r=void 0!==e.pageXOffset,o="CSS1Compat"===(t.compatMode||""),i=e.navigator.userAgent,a=/[\s\S](?:\.\.\.)?$/,u=/(iPhone|iPad|iPod|Android|blackberry)/i,s=function(){},c=e.console,l=e.okanjo||{},f={version:"1.20.0",metrics:null,key:l.key||null,report:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t.find(function(e){return e instanceof Error});if(r){var o=(new Error).stack.split("\n");o.shift(),o.shift(),t.push({reportStack:o.join("\n")}),t=t.filter(function(e){return e!==r})}else{var i=t.findIndex(function(e){return"string"==typeof e});r=new Error(t[i]||"Okanjo Error"),i>=0&&t.splice(i,1)}c.error("[Okanjo v"+f.version+"]: "+r.stack),t.length&&c.error.apply(c,["Additional information:"].concat(t))},warn:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var o=new Error(e);c.warn("[Okanjo v"+f.version+"]: "+o.stack),n.length&&c.warn.apply(c,["Additional information:"].concat(n))},qwery:function(e,n){return"string"!=typeof n||(n=t.querySelector(n))?(n||(n=t),n.querySelectorAll(e)):[]}};/*! based on shortid https://github.com/dylang/shortid */
return f.lib={},f.net={endpoint:"https://api2.okanjo.com",sandboxEndpoint:"https://sandbox-api2.okanjo.com",routes:{ads:"/content",metrics:"/metrics/:object_type/:event_type",metrics_batch:"/metrics"},getRoute:function(e,t,n){return t&&Object.keys(t).forEach(function(n){e=e.replace(":"+n,t[n]+"")}),n=n||f.env||"live",("sandbox"===n?f.net.sandboxEndpoint:f.net.endpoint)+e},request:s},f.util={isEmpty:function(e){return null===e||void 0===e||"string"==typeof e&&0===e.trim().length},isMobile:function(){return u.test(i)},getPageArguments:function(t){var n=function(e){e=e||"";var t={},n=e.split("&");return n.forEach(function(e){var n=e.indexOf("="),r=void 0,o=void 0;n<0?(r=decodeURIComponent(e),o=null):(r=decodeURIComponent(e.substring(0,n)),o=decodeURIComponent(e.substring(n+1))),r&&(t[r]=o)}),t},r=n(e.location.search.substring(e.location.search.indexOf("?")+1)),o=t?n(e.location.hash.substring(Math.max(e.location.hash.indexOf("#")+1,e.location.hash.indexOf("#!")+2))):{};return Object.keys(o).forEach(function(e){return r[e]=o[e]}),r}},f.util.deepClone=function(e,t){return Array.isArray(e)?(t=t||[],t=t.concat(e.map(function(e){return f.util.deepClone(e)}))):"object"===("undefined"==typeof e?"undefined":n(e))&&null!==e?(t=t||{},Object.keys(e).forEach(function(n){t[n]=f.util.deepClone(e[n])})):t=e,t},f.util.flatten=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={};return void 0!==e&&null!==e&&Object.keys(e).forEach(function(o){if(e[o]instanceof Date)t.dateToIso?r[o]=e[o].toISOString():r[o]=e[o];else if("object"===n(e[o])&&null!==e[o])if(Array.isArray(e[o])&&t.ignoreArrays===!0)r[o]=e[o];else if(Array.isArray(e[o])&&t.arrayToCsv===!0)r[o]=e[o].join(",");else{var i=f.util.flatten(e[o],t);Object.keys(i).forEach(function(e){r[o+"_"+e]=i[e]})}else r[o]=e[o]}),r},f.util.shortid=function(t){var n="ylZM7VHLvOFcohp01x-fXNr8P_tqin6RkgWGm4SIDdK5s2TAJebzQEBUwuY9j3aC",r=e.crypto||e.msCrypto||"function"==typeof require&&require("crypto"),o=function(){if(r&&r.randomBytes)return 48&r.randomBytes(1)[0];if(!r||!r.getRandomValues)return 48&Math.floor(256*Math.random());var e=new Uint8Array(1);return r.getRandomValues(e),48&e[0]},i=function(e){for(var t=0,r=void 0,i="";!r;)i+=n[e>>4*t&15|o()],r=e<Math.pow(16,t+1),t++;return i},a=1490384907498,u=7,s=void 0,c=void 0;return t=t||0,function(){var e="",n=Math.floor(.001*((new Date).getTime()-a));return n===c?s++:(s=0,c=n),e=e+i(u)+i(t),s>0&&(e+=i(s)),e+=i(n)}}(),f.util.getLocation=function(){return e.location!==e.parent.location?t.referrer:t.location.href},f.ui={getScrollPosition:function(){return{x:r?e.pageXOffset:o?t.documentElement.scrollLeft:t.body.scrollLeft,y:r?e.pageYOffset:o?t.documentElement.scrollTop:t.body.scrollTop}},getElementSize:function(t,n){var r={height:t.offsetHeight,width:t.offsetWidth},o=t.currentStyle||e.getComputedStyle(t);return n&&(r.height+=parseInt(o.marginTop)+parseInt(o.marginBottom),r.width+=parseInt(o.marginLeft)+parseInt(o.marginRight)),r},getPageSize:function(){var e=t.querySelector("body"),n=t.documentElement;return{w:Math.max(e.scrollWidth,e.offsetWidth,n.clientWidth,n.scrollWidth,n.offsetWidth),h:Math.max(e.scrollHeight,e.offsetHeight,n.clientHeight,n.scrollHeight,n.offsetHeight)}},getViewportSize:function(){var n=o?t.documentElement:t.body,r=n.clientWidth,i=n.clientHeight,a=e.innerWidth||0,u=e.innerHeight||0,s=a&&r>a||u&&i>u;return{vw:s?a:r,vh:s?u:i}},getEventPosition:function(e){var n=e.pageX,r=e.pageY,o=t.body,i=t.documentElement,a="scrollLeft",u="scrollTop",s=e.__proto__.constructor.name;return{et:s,ex:void 0===n?e.clientX+o[a]+i[a]:n,ey:void 0===r?e.clientY+o[u]+i[u]:r}},getElementPosition:function(e){var n="Could not get position of element. Did you attach the element to the DOM before initializing?";try{var r=e.getBoundingClientRect(),o=t.body.getBoundingClientRect();return t.body.contains(e)||f.report(n,e),{x1:r.left-o.left,y1:r.top-o.top,x2:r.right-o.left,y2:r.bottom-o.top}}catch(i){return f.report(n,{exception:i,element:e}),{x1:0,y1:0,x2:0,y2:0,err:1}}},_getIntersection:function(e,t,n){var r=Math.max(e.x1,t.x),o=Math.min(e.x2,t.x+n.vw),i=Math.max(e.y1,t.y),a=Math.min(e.y2,t.y+n.vh),u=Math.max(0,o-r)*Math.max(0,a-i),s=(e.x2-e.x1)*(e.y2-e.y1);return{intersectionArea:u,elementArea:s}},isElementVisible:function(e){return e.offsetWidth>0&&e.offsetHeight>0},getPercentageInViewport:function(e){var t=f.ui.getElementPosition(e),n=f.ui.getScrollPosition(),r=f.ui.getViewportSize();if(t.err)return 0;var o=f.ui._getIntersection(t,n,r),i=o.intersectionArea,a=o.elementArea;return a<=0?0:i/a}},f.ui.ellipsify=function(e,n){for(var r=n||e.parentNode,o=f.ui.getElementSize(r).height,i=void 0!==e.textContent,u=i?e.textContent:e.innerText,s="",c=5e3,l=function(e){return s=e.substr(0,e.length-3)+s,"..."};f.ui.getElementSize(e).height>o&&u.length>0&&c-- >0;)u=i?e.textContent:e.innerText,u=u.replace(a,l),i?e.textContent=u:e.innerText=u;if(s.length>0){var d=t.createElement("span"),h=t.createElement("span");d.setAttribute("class","okanjo-ellipses"),h.setAttribute("class","okanjo-visually-hidden"),i?(d.textContent=u.substr(0,u.length-3),h.textContent=s):(d.innerText=u.substr(0,u.length-3),h.innerText=s),e.innerHTML="",e.appendChild(d),e.appendChild(h)}},f.ui.fitImages=function(e){"objectFit"in t.documentElement.style==!1&&e.querySelectorAll("img.okanjo-fit").forEach(function(e){e.style.display="none";var t=e.parentNode;t.style.backgroundSize="cover",t.style.backgroundImage="url("+e.src+")",t.style.backgroundposition="center center"})},e.okanjo=f}(window,document);return function(e){var t=/^application\/json/,r=e.okanjo;r.net.request=function(n,o,i,a){"function"==typeof i&&(a=i,i=void 0);var u=new(e.XMLHttpRequest||e.ActiveXObject)("MSXML2.XMLHTTP.3.0"),s=!1,c=function(e,t){s||(s=!0,a(e,t))};r.net.request.timeout&&(u.timeout=r.net.request.timeout),u.ontimeout=function(e){c({statusCode:504,error:"Request timed out",message:"Something went wrong",attributes:{event:e,xhr:u}})},u.onreadystatechange=function(e){if(4===u.readyState)if(u.status>0){var n=void 0;n=t.test(u.getResponseHeader("Content-Type"))?JSON.parse(u.responseText):{statusCode:u.status,data:u.responseText},u.status>=200&&u.status<300?c(null,n):c(n)}else c({statusCode:503,error:"Request failed",message:"Something went wrong",attributes:{event:e,xhr:u}})},u.open(n.toUpperCase(),o),u.withCredentials=!0,["POST","PUT","PATCH"].includes(n.toUpperCase())&&(u.setRequestHeader("Content-Type","application/json; charset=utf-8"),void 0!==i&&(i=JSON.stringify(i))),u.send(i||void 0)},r.net.request.get=r.net.request.bind(this,"GET"),r.net.request.post=r.net.request.bind(this,"POST"),r.net.request.put=r.net.request.bind(this,"PUT"),r.net.request["delete"]=r.net.request.bind(this,"DELETE");var o=function(e){return null===e||void 0===e?"":encodeURIComponent(""+e)},i=function(e,t){return t?t+"["+o(e)+"]":o(e)};r.net.request.stringify=function(e,t){var a=[];return t=t||"",Object.keys(e).forEach(function(u){var s=e[u];if(Array.isArray(s))s.forEach(function(e){return a.push(i(u,t)+"="+o(e))});else if("object"===("undefined"==typeof s?"undefined":n(s))&&null!==s){var c=r.net.request.stringify(s,i(u,t));c&&a.push(c)}else void 0!==s&&a.push(i(u,t)+"="+o(s))}),a.join("&")}}(window),function(e,t){e.okanjo.util.cookie={set:function(n,r,o){var i=new Date;i.setDate(i.getDate()+o);var a=o?" Expires="+i.toUTCString()+";":"",u=" Path=/",s="https:"===e.location.protocol?" Secure;":"",c=encodeURI(r)+";"+a+s+" SameSite=None;"+u;t.cookie=n+"="+c},get:function(e){var n=null;return t.cookie.split(";").find(function(t){var r=t.substr(0,t.indexOf("=")).trim(),o=t.substr(t.indexOf("=")+1);return r===e&&(n=decodeURI(o),!0)}),n}}}(window,document),function(n,r){var o=n.okanjo,i=function(){function i(){e(this,i),this._queue=this._getStoredQueue(),this._processTimeout=null,this.pageId=o.util.shortid(),this.defaultChannel=i.Channel.external,this.sid=null,this.sourceCh=null,this.sourceCx=null,this._checkUrlForReferral()}return t(i,[{key:"_getStoredQueue",value:function(){if(!n.localStorage[i.Params.queue])return[];try{var e=JSON.parse(n.localStorage[i.Params.queue]);return Array.isArray(e)?e:(o.report("Stored queue is not a queue",{queue:e}),[])}catch(t){return o.report("Failed to load metric queue from storage",{err:t}),[]}}},{key:"_saveQueue",value:function(e){var t=this;e?(this._saveQueueTimeout&&clearTimeout(this._saveQueueTimeout),this._saveQueueTimeout=setTimeout(function(){t._saveQueue(!1),t._saveQueueTimeout=null},100)):n.localStorage[i.Params.queue]=JSON.stringify(this._queue)}},{key:"_checkUrlForReferral",value:function(){var e=o.util.getPageArguments(!0),t=e[i.Params.name],r=n.localStorage[i.Params.name]||o.util.cookie.get(i.Params.name),a=e[i.Params.context],u=e[i.Params.channel];t&&r&&t!==r&&this.trackEvent({object_type:i.Object.metric_session,event_type:i.Event.correlation,id:t+"_"+r,ch:this.defaultChannel,_noProcess:!0}),this.sid=r||t||null,this.sourceCh=u||null,this.sourceCx=a||null}},{key:"trackEvent",value:function(e,t){return e.object_type&&e.event_type?void this._push(e,t):void o.report("Invalid metric to track (missing object_type or event_type)",{event:e})}},{key:"trackPageView",value:function(e,t){e=e||{},e.object_type=i.Object.page,e.event_type=i.Event.view,e.id=e.id||o.util.getLocation(),e.ch=e.ch||this.defaultChannel,this.trackEvent(e,t)}},{key:"_push",value:function(e,t){this._queue.push({event:e,callback:t}),this._saveQueue(!0),e._noProcess?delete e._noProcess:this._processQueue()}},{key:"_processQueue",value:function(){var e=this;!this._processTimeout&&this._queue.length>0&&(this._processTimeout=setTimeout(function(){var t=e._queue.splice(0,255);e._saveQueue(!1),e._batchSend(t,function(n,r){r&&r.data&&r.data.sid&&e._updateSid(r.data.sid),e._processTimeout=null,e._processQueue(),t.forEach(function(e){e.callback&&e.callback(n,r)})})},0))}},{key:"_batchSend",value:function(e,t){var n=this,r=e.map(function(e){return n._normalizeEvent(e.event),delete e.event.sid,delete e.event.win,e.event}),i={events:r,win:o.util.getLocation()},a=o.net.getRoute(o.net.routes.metrics_batch);this.sid&&(i.sid=this.sid),o.net.request.post(a,i,function(n,r){n&&o.report("Failed to send metrics batch",{err:n,res:r,items:e,route:a}),t&&t(n,r)})}},{key:"_normalizeEvent",value:function(e){e.m=e.m||{},e.key=e.key||e.m.key||o.key||void 0,this.sid&&(e.sid=this.sid),e.m=Object.assign({},e.m),Object.keys(i.Meta.exclude).forEach(function(t){return delete e.m[t]}),this.sourceCh&&(e.m.ref_ch=this.sourceCh),this.sourceCx&&(e.m.ref_cx=this.sourceCx),e.m.pgid=this.pageId,e.m.ok_ver=o.version,e.m=o.util.flatten(e.m,{arrayToCsv:!0}),Object.keys(e.m).forEach(function(t){"string"==typeof e.m[t]&&(e.m[t]=e.m[t].substr(0,255))}),r.referrer&&(e.ref=r.referrer),e.win=o.util.getLocation()}},{key:"_updateSid",value:function(e){!e||this.sid&&this.sid===e||(this.sid=e,n.localStorage[i.Params.name]=e,o.util.cookie.set(i.Params.name,e,i.Params.ttl))}},{key:"create",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return i.create.apply(null,t)}}],[{key:"addElementInfo",value:function(e,t){var n=o.ui.getPageSize(),r=o.ui.getElementPosition(e);return t=t||{},t.m=t.m||{},t.m.pw=n.w,t.m.ph=n.h,t.m.x1=r.x1,t.m.y1=r.y1,t.m.x2=r.x2,t.m.y2=r.y2,t}},{key:"addWidgetInfo",value:function(e,t){var n=o.ui.getElementPosition(e);t=t||{},t.m=t.m||{},t.m.wox1=n.x1,t.m.woy1=n.y1,t.m.wox2=n.x2,t.m.woy2=n.y2;var r=o.qwery(".okanjo-resource, .okanjo-adx-container",e),i=void 0,a=void 0,u=void 0,s=void 0,c=void 0,l=[],f=function(e,t){return"undefined"==typeof t||e<t?e:t},d=function(e,t){return"undefined"==typeof t||e>t?e:t},h=function(e,t){return"undefined"==typeof e?t:e};return r.forEach(function(e){i=o.ui.getElementPosition(e),a=f(i.x1,a),u=f(i.y1,u),s=d(i.x2,s),c=d(i.y2,c),l.push(i.x1,i.y1,i.x2,i.y2)}),t.m.wix1=h(a,n.x1),t.m.wiy1=h(u,n.y1),t.m.wix2=h(s,n.x2),t.m.wiy2=h(c,n.y2),t.m.wrps=l.map(function(e){return Math.floor(e)}).join(","),t}},{key:"addViewportInfo",value:function(e){var t=o.ui.getViewportSize(),n=o.ui.getScrollPosition();return e=e||{},e.m=e.m||{},e.m.vx1=n.x,e.m.vy1=n.y,e.m.vx2=n.x+t.vw,e.m.vy2=n.y+t.vh,e}},{key:"addEventInfo",value:function(e,t){var n=o.ui.getEventPosition(e);return t=t||{},t.m=t.m||{},t.m.et=n.et,t.m.ex=n.ex,t.m.ey=n.ey,t}},{key:"addEventMeta",value:function(e){e=e||{},e.m=e.m||{};for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return e.m=Object.assign.apply(Object,[e.m].concat(n)),e}},{key:"create",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return new a(e,n)}}]),i}();i.Params={queue:"_ok_q",name:"ok_msid",channel:"ok_ch",context:"ok_cx",ttl:1460},i.Meta={exclude:["key","callback","metrics_channel_context","metrics_context","mode"]},i.Event={view:"vw",impression:"imp",interaction:"int",correlation:"cor"},i.Action={click:"click",inline_click:"inline_click"},i.Object={article:"am",thirdparty_ad:"ta",cart:"ct",page:"pg",widget:"wg",product:"pr",store:"st",cause:"ca",marketplace:"mp",order:"or",order_item:"oi",user:"ur",metric_session:"mt"},i.Channel={placement:"pw",marketplace:"mp",external:"ex",product_widget:"pw",ad_widget:"aw",store_widget:"sw"},i.Environment={live:"live",testing:"testing"};var a=function(){function n(t,r){var o=this;e(this,n),t=t||{},this.data(t),Array.isArray(r)&&r.forEach(function(e){o.data(e)})}return t(n,[{key:"data",value:function(e){return Object.assign(this,o.util.deepClone(e)),this}},{key:"event",value:function(e){return i.addEventInfo(e,this),this}},{key:"viewport",value:function(){return i.addViewportInfo(this),this}},{key:"element",value:function(e){return i.addElementInfo(e,this),this}},{key:"widget",value:function(e){return i.addWidgetInfo(e,this),this}},{key:"meta",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return i.addEventMeta.apply(null,[this].concat(t)),this}},{key:"type",value:function(e,t){return this.object_type=e,this.event_type=t,this}},{key:"send",value:function(e){o.metrics.trackEvent(this,e)}},{key:"toUrl",value:function(){var e=Object.assign({},this),t=e.object_type,n=e.event_type;return delete e.object_type,delete e.event_type,o.metrics._normalizeEvent(e),o.net.getRoute(o.net.routes.metrics,{object_type:t,event_type:n})+"?"+o.net.request.stringify(e)}}]),n}();o.metrics=new i}(window,document),r});
//# sourceMappingURL=okanjo-metrics.min.js.map
